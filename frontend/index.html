<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VendreFacile</title>
  <style>
    :root {
      --primary: #ff6600;
      --primary-dark: #e55c00;
      --bg: #f5f5f5;
      --card: #fff;
      --text: #333;
      --text-light: #777;
      --border: #ddd;
      --success: #28a745;
      --danger: #dc3545;
      --radius: 8px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); }

    /* NAV */
    nav { background: var(--primary); color: #fff; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 56px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
    nav .logo { font-size: 1.4rem; font-weight: 700; cursor: pointer; }
    nav .nav-links { display: flex; gap: 12px; align-items: center; }
    nav button, nav .nav-btn { background: rgba(255,255,255,.2); border: none; color: #fff; padding: 8px 14px; border-radius: var(--radius); cursor: pointer; font-size: .9rem; transition: background .2s; }
    nav button:hover, nav .nav-btn:hover { background: rgba(255,255,255,.35); }

    /* LAYOUT */
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .page { display: none; }
    .page.active { display: block; }

    /* CARDS */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
    .card { background: var(--card); border-radius: var(--radius); overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,.08); transition: transform .15s, box-shadow .15s; cursor: pointer; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.12); }
    .card-body { padding: 16px; }
    .card-body h3 { font-size: 1.05rem; margin-bottom: 6px; }
    .card-body .price { color: var(--primary); font-weight: 700; font-size: 1.2rem; }
    .card-body .meta { color: var(--text-light); font-size: .85rem; margin-top: 6px; }

    /* FORMS */
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: .9rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); font-size: .95rem; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .btn { display: inline-block; padding: 10px 20px; background: var(--primary); color: #fff; border: none; border-radius: var(--radius); cursor: pointer; font-size: .95rem; font-weight: 600; transition: background .2s; }
    .btn:hover { background: var(--primary-dark); }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    .btn-outline:hover { background: var(--primary); color: #fff; }
    .btn-danger { background: var(--danger); }
    .btn-sm { padding: 6px 12px; font-size: .85rem; }

    /* SEARCH BAR */
    .search-bar { display: flex; gap: 10px; flex-wrap: wrap; background: var(--card); padding: 16px; border-radius: var(--radius); box-shadow: 0 1px 4px rgba(0,0,0,.08); }
    .search-bar input, .search-bar select { padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); font-size: .95rem; flex: 1; min-width: 140px; }

    /* AUTH MODAL */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 200; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--card); border-radius: 12px; padding: 30px; width: 400px; max-width: 90vw; position: relative; }
    .modal h2 { margin-bottom: 20px; }
    .modal .close { position: absolute; top: 12px; right: 16px; font-size: 1.4rem; cursor: pointer; background: none; border: none; color: var(--text-light); }
    .tabs { display: flex; gap: 0; margin-bottom: 20px; }
    .tabs button { flex: 1; padding: 10px; border: none; background: var(--bg); cursor: pointer; font-weight: 600; font-size: .95rem; }
    .tabs button.active { background: var(--primary); color: #fff; }
    .tabs button:first-child { border-radius: var(--radius) 0 0 var(--radius); }
    .tabs button:last-child { border-radius: 0 var(--radius) var(--radius) 0; }

    /* DETAIL */
    .detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap; }
    .detail-header h1 { font-size: 1.6rem; }
    .detail-info { margin-top: 16px; line-height: 1.8; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: .8rem; font-weight: 600; }
    .badge-active { background: #e6f9ee; color: var(--success); }
    .badge-sold { background: #fde8e8; color: var(--danger); }

    /* MESSAGES */
    .chat-box { border: 1px solid var(--border); border-radius: var(--radius); height: 350px; overflow-y: auto; padding: 12px; margin-bottom: 12px; background: #fafafa; }
    .msg { margin-bottom: 10px; max-width: 75%; }
    .msg.mine { margin-left: auto; text-align: right; }
    .msg .bubble { display: inline-block; padding: 8px 14px; border-radius: 16px; font-size: .93rem; }
    .msg.mine .bubble { background: var(--primary); color: #fff; }
    .msg.other .bubble { background: #e9e9e9; }
    .msg .msg-meta { font-size: .75rem; color: var(--text-light); margin-top: 2px; }
    .chat-input { display: flex; gap: 8px; }
    .chat-input input { flex: 1; }

    /* CONV LIST */
    .conv-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--card); border-radius: var(--radius); margin-bottom: 8px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,.06); transition: background .15s; }
    .conv-item:hover { background: #f0f0f0; }

    /* PROFILE */
    .profile-card { background: var(--card); padding: 24px; border-radius: var(--radius); box-shadow: 0 1px 4px rgba(0,0,0,.08); max-width: 500px; }

    .alert { padding: 12px 16px; border-radius: var(--radius); margin-bottom: 14px; font-size: .9rem; }
    .alert-error { background: #fde8e8; color: var(--danger); }
    .alert-success { background: #e6f9ee; color: var(--success); }

    .empty { text-align: center; padding: 40px; color: var(--text-light); }

    @media (max-width: 600px) {
      .search-bar { flex-direction: column; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <span class="logo" onclick="showPage('home')">VendreFacile</span>
  <div class="nav-links">
    <button onclick="showPage('home')">Annonces</button>
    <span id="nav-auth"></span>
  </div>
</nav>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="authModal">
  <div class="modal">
    <button class="close" onclick="closeModal()">&times;</button>
    <div class="tabs">
      <button id="tabLogin" class="active" onclick="switchTab('login')">Connexion</button>
      <button id="tabRegister" onclick="switchTab('register')">Inscription</button>
    </div>
    <div id="authAlert"></div>
    <form id="loginForm" onsubmit="return handleLogin(event)">
      <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div>
      <div class="form-group"><label>Mot de passe</label><input type="password" id="loginPass" required></div>
      <button class="btn" style="width:100%">Se connecter</button>
    </form>
    <form id="registerForm" style="display:none" onsubmit="return handleRegister(event)">
      <div class="form-group"><label>Pseudo</label><input id="regUser" required></div>
      <div class="form-group"><label>Email</label><input type="email" id="regEmail" required></div>
      <div class="form-group"><label>Mot de passe</label><input type="password" id="regPass" required minlength="6"></div>
      <div class="form-group"><label>Ville</label><input id="regCity"></div>
      <button class="btn" style="width:100%">S'inscrire</button>
    </form>
  </div>
</div>

<div class="container">

  <!-- HOME -->
  <div class="page active" id="page-home">
    <h2 style="margin-bottom:14px">Rechercher une annonce</h2>
    <div class="search-bar">
      <input id="searchQ" placeholder="Recherche..." onkeyup="if(event.key==='Enter')searchAnnonces()">
      <input id="searchCity" placeholder="Ville">
      <input id="searchPriceMin" type="number" placeholder="Prix min">
      <input id="searchPriceMax" type="number" placeholder="Prix max">
      <select id="searchCat"><option value="">Catégorie</option></select>
      <button class="btn" onclick="searchAnnonces()">Rechercher</button>
    </div>
    <div class="grid" id="annoncesList"></div>
  </div>

  <!-- DETAIL -->
  <div class="page" id="page-detail">
    <button class="btn btn-outline btn-sm" onclick="showPage('home')" style="margin-bottom:16px">&larr; Retour</button>
    <div id="detailContent"></div>
  </div>

  <!-- CREATE / EDIT -->
  <div class="page" id="page-create">
    <h2 id="createTitle">Publier une annonce</h2>
    <div style="max-width:550px">
      <div id="createAlert"></div>
      <form onsubmit="return handleCreateAnnonce(event)">
        <div class="form-group"><label>Titre</label><input id="cTitle" required></div>
        <div class="form-group"><label>Description</label><textarea id="cDesc"></textarea></div>
        <div class="form-group"><label>Prix (€)</label><input type="number" step="0.01" id="cPrice"></div>
        <div class="form-group"><label>Ville</label><input id="cCity"></div>
        <div class="form-group"><label>Catégorie</label><select id="cCat"><option value="">--</option></select></div>
        <button class="btn">Publier</button>
      </form>
    </div>
  </div>

  <!-- MES ANNONCES -->
  <div class="page" id="page-myads">
    <h2>Mes annonces</h2>
    <div class="grid" id="myAdsList"></div>
  </div>

  <!-- FAVORIS -->
  <div class="page" id="page-favorites">
    <h2>Mes favoris</h2>
    <div class="grid" id="favList"></div>
  </div>

  <!-- CONVERSATIONS -->
  <div class="page" id="page-conversations">
    <h2>Messagerie</h2>
    <div id="convList"></div>
  </div>

  <!-- CHAT -->
  <div class="page" id="page-chat">
    <button class="btn btn-outline btn-sm" onclick="showPage('conversations')" style="margin-bottom:16px">&larr; Retour</button>
    <h2 id="chatTitle"></h2>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Écrire un message..." onkeyup="if(event.key==='Enter')sendMessage()">
      <button class="btn" onclick="sendMessage()">Envoyer</button>
    </div>
  </div>

  <!-- PROFIL -->
  <div class="page" id="page-profile">
    <h2>Mon profil</h2>
    <div class="profile-card" style="margin-top:14px">
      <div id="profileAlert"></div>
      <form onsubmit="return handleUpdateProfile(event)">
        <div class="form-group"><label>Pseudo</label><input id="pUser"></div>
        <div class="form-group"><label>Téléphone</label><input id="pPhone"></div>
        <div class="form-group"><label>Ville</label><input id="pCity"></div>
        <button class="btn">Sauvegarder</button>
      </form>
    </div>
  </div>

</div>

<script>
const API = '/api';
let token = localStorage.getItem('token');
let currentUser = null;
let categories = [];
let currentConvId = null;

// ── API helper ──────────────────────────────────────────
async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(API + path, { ...opts, headers });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Erreur');
  return data;
}

// ── Auth state ──────────────────────────────────────────
function updateNav() {
  const el = document.getElementById('nav-auth');
  if (token && currentUser) {
    el.innerHTML = `
      <button onclick="showPage('create')">+ Publier</button>
      <button onclick="showPage('myads')">Mes annonces</button>
      <button onclick="showPage('favorites')">Favoris</button>
      <button onclick="showPage('conversations')">Messages</button>
      <button onclick="showPage('profile')">${currentUser.username}</button>
      <button onclick="logout()">Déconnexion</button>`;
  } else {
    el.innerHTML = `<button onclick="openModal()">Connexion</button>`;
  }
}

async function initAuth() {
  if (token) {
    try { currentUser = await api('/profile'); } catch { token = null; localStorage.removeItem('token'); }
  }
  updateNav();
}

function logout() { token = null; currentUser = null; localStorage.removeItem('token'); updateNav(); showPage('home'); }

// ── Modal ───────────────────────────────────────────────
function openModal() { document.getElementById('authModal').classList.add('active'); }
function closeModal() { document.getElementById('authModal').classList.remove('active'); document.getElementById('authAlert').innerHTML = ''; }
function switchTab(t) {
  document.getElementById('loginForm').style.display = t === 'login' ? '' : 'none';
  document.getElementById('registerForm').style.display = t === 'register' ? '' : 'none';
  document.getElementById('tabLogin').classList.toggle('active', t === 'login');
  document.getElementById('tabRegister').classList.toggle('active', t === 'register');
}

async function handleLogin(e) {
  e.preventDefault();
  try {
    const d = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPass').value }) });
    token = d.token; currentUser = d.user; localStorage.setItem('token', token); closeModal(); updateNav();
  } catch (err) { document.getElementById('authAlert').innerHTML = `<div class="alert alert-error">${err.message}</div>`; }
  return false;
}

async function handleRegister(e) {
  e.preventDefault();
  try {
    const d = await api('/auth/register', { method: 'POST', body: JSON.stringify({ username: document.getElementById('regUser').value, email: document.getElementById('regEmail').value, password: document.getElementById('regPass').value, city: document.getElementById('regCity').value }) });
    token = d.token; currentUser = d.user; localStorage.setItem('token', token); closeModal(); updateNav();
  } catch (err) { document.getElementById('authAlert').innerHTML = `<div class="alert alert-error">${err.message}</div>`; }
  return false;
}

// ── Pages ───────────────────────────────────────────────
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (name === 'home') searchAnnonces();
  if (name === 'myads') loadMyAds();
  if (name === 'favorites') loadFavorites();
  if (name === 'conversations') loadConversations();
  if (name === 'profile') loadProfile();
}

// ── Categories ──────────────────────────────────────────
async function loadCategories() {
  categories = await api('/categories');
  ['searchCat', 'cCat'].forEach(id => {
    const sel = document.getElementById(id);
    const first = sel.options[0];
    sel.innerHTML = '';
    sel.appendChild(first);
    categories.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; sel.appendChild(o); });
  });
}

// ── Annonces ────────────────────────────────────────────
async function searchAnnonces() {
  const params = new URLSearchParams();
  const q = document.getElementById('searchQ').value; if (q) params.set('q', q);
  const city = document.getElementById('searchCity').value; if (city) params.set('city', city);
  const pmin = document.getElementById('searchPriceMin').value; if (pmin) params.set('price_min', pmin);
  const pmax = document.getElementById('searchPriceMax').value; if (pmax) params.set('price_max', pmax);
  const cat = document.getElementById('searchCat').value; if (cat) params.set('category_id', cat);
  try {
    const annonces = await api('/annonces?' + params.toString());
    const el = document.getElementById('annoncesList');
    if (!annonces.length) { el.innerHTML = '<div class="empty">Aucune annonce trouvée</div>'; return; }
    el.innerHTML = annonces.map(a => `
      <div class="card" onclick="showDetail(${a.id})">
        <div class="card-body">
          <h3>${esc(a.title)}</h3>
          <div class="price">${a.price ? a.price + ' €' : 'Gratuit'}</div>
          <div class="meta">${esc(a.city || '')} · ${esc(a.category_name || '')} · ${timeAgo(a.created_at)}</div>
        </div>
      </div>`).join('');
  } catch (err) { console.error(err); }
}

async function showDetail(id) {
  try {
    const a = await api('/annonces/' + id);
    const isMine = currentUser && currentUser.id === a.user_id;
    document.getElementById('detailContent').innerHTML = `
      <div class="detail-header">
        <div>
          <h1>${esc(a.title)}</h1>
          <span class="badge badge-${a.status}">${a.status}</span>
        </div>
        <div class="price" style="font-size:1.8rem">${a.price ? a.price + ' €' : 'Gratuit'}</div>
      </div>
      <div class="detail-info">
        <p>${esc(a.description || 'Pas de description')}</p>
        <p><strong>Ville :</strong> ${esc(a.city || 'Non précisée')}</p>
        <p><strong>Catégorie :</strong> ${esc(a.category_name || '-')}</p>
        <p><strong>Vendeur :</strong> ${esc(a.seller_name)}</p>
        <p><strong>Publié :</strong> ${new Date(a.created_at).toLocaleDateString('fr-FR')}</p>
      </div>
      <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
        ${!isMine && token ? `<button class="btn btn-outline" onclick="addFavorite(${a.id})">&#9825; Favori</button>
        <button class="btn" onclick="startConversation(${a.id})">Contacter le vendeur</button>` : ''}
        ${isMine ? `<button class="btn btn-danger btn-sm" onclick="deleteAnnonce(${a.id})">Supprimer</button>` : ''}
      </div>`;
    showPage('detail');
  } catch (err) { alert(err.message); }
}

async function handleCreateAnnonce(e) {
  e.preventDefault();
  try {
    await api('/annonces', { method: 'POST', body: JSON.stringify({
      title: document.getElementById('cTitle').value,
      description: document.getElementById('cDesc').value,
      price: document.getElementById('cPrice').value || null,
      city: document.getElementById('cCity').value,
      category_id: document.getElementById('cCat').value || null
    })});
    document.getElementById('createAlert').innerHTML = '<div class="alert alert-success">Annonce publiée !</div>';
    document.getElementById('cTitle').value = ''; document.getElementById('cDesc').value = '';
    document.getElementById('cPrice').value = ''; document.getElementById('cCity').value = '';
    setTimeout(() => showPage('myads'), 800);
  } catch (err) { document.getElementById('createAlert').innerHTML = `<div class="alert alert-error">${err.message}</div>`; }
  return false;
}

async function loadMyAds() {
  if (!token) return;
  try {
    const mine = await api('/annonces/mine');
    const el = document.getElementById('myAdsList');
    if (!mine.length) { el.innerHTML = '<div class="empty">Aucune annonce</div>'; return; }
    el.innerHTML = mine.map(a => `
      <div class="card" onclick="showDetail(${a.id})">
        <div class="card-body">
          <h3>${esc(a.title)}</h3>
          <div class="price">${a.price ? a.price + ' €' : 'Gratuit'}</div>
          <div class="meta">${esc(a.city || '')} · <span class="badge badge-${a.status}">${a.status}</span></div>
        </div>
      </div>`).join('');
  } catch (err) { console.error(err); }
}

async function deleteAnnonce(id) {
  if (!confirm('Supprimer cette annonce ?')) return;
  try { await api('/annonces/' + id, { method: 'DELETE' }); showPage('home'); } catch (err) { alert(err.message); }
}

// ── Favoris ─────────────────────────────────────────────
async function addFavorite(annonceId) {
  try { await api('/favorites/' + annonceId, { method: 'POST' }); alert('Ajouté aux favoris !'); } catch (err) { alert(err.message); }
}

async function loadFavorites() {
  if (!token) return;
  try {
    const favs = await api('/favorites');
    const el = document.getElementById('favList');
    if (!favs.length) { el.innerHTML = '<div class="empty">Aucun favori</div>'; return; }
    el.innerHTML = favs.map(f => `
      <div class="card" onclick="showDetail(${f.annonce_id})">
        <div class="card-body">
          <h3>${esc(f.title)}</h3>
          <div class="price">${f.price ? f.price + ' €' : 'Gratuit'}</div>
          <div class="meta">${esc(f.city || '')}</div>
        </div>
      </div>`).join('');
  } catch (err) { console.error(err); }
}

// ── Messagerie ──────────────────────────────────────────
async function loadConversations() {
  if (!token) return;
  try {
    const convs = await api('/conversations');
    const el = document.getElementById('convList');
    if (!convs.length) { el.innerHTML = '<div class="empty">Aucune conversation</div>'; return; }
    el.innerHTML = convs.map(c => `
      <div class="conv-item" onclick="openChat(${c.id}, '${esc(c.annonce_title)}')">
        <div><strong>${esc(c.annonce_title)}</strong><br><span style="color:var(--text-light);font-size:.85rem">avec ${esc(c.other_user)}</span></div>
        <span style="color:var(--text-light);font-size:.8rem">${timeAgo(c.created_at)}</span>
      </div>`).join('');
  } catch (err) { console.error(err); }
}

async function startConversation(annonceId) {
  if (!token) { openModal(); return; }
  try {
    const c = await api('/conversations', { method: 'POST', body: JSON.stringify({ annonce_id: annonceId }) });
    openChat(c.id, '');
  } catch (err) { alert(err.message); }
}

async function openChat(convId, title) {
  currentConvId = convId;
  document.getElementById('chatTitle').textContent = title || 'Conversation';
  showPage('chat');
  await refreshMessages();
}

async function refreshMessages() {
  if (!currentConvId) return;
  try {
    const msgs = await api('/conversations/' + currentConvId + '/messages');
    const box = document.getElementById('chatBox');
    box.innerHTML = msgs.map(m => `
      <div class="msg ${m.sender_id === currentUser.id ? 'mine' : 'other'}">
        <div class="bubble">${esc(m.content)}</div>
        <div class="msg-meta">${esc(m.sender_name)} · ${timeAgo(m.created_at)}</div>
      </div>`).join('');
    box.scrollTop = box.scrollHeight;
  } catch (err) { console.error(err); }
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const content = input.value.trim();
  if (!content) return;
  try {
    await api('/conversations/' + currentConvId + '/messages', { method: 'POST', body: JSON.stringify({ content }) });
    input.value = '';
    await refreshMessages();
  } catch (err) { alert(err.message); }
}

// ── Profil ──────────────────────────────────────────────
async function loadProfile() {
  if (!token) return;
  try {
    const p = await api('/profile');
    document.getElementById('pUser').value = p.username || '';
    document.getElementById('pPhone').value = p.phone || '';
    document.getElementById('pCity').value = p.city || '';
  } catch (err) { console.error(err); }
}

async function handleUpdateProfile(e) {
  e.preventDefault();
  try {
    const d = await api('/profile', { method: 'PUT', body: JSON.stringify({ username: document.getElementById('pUser').value, phone: document.getElementById('pPhone').value, city: document.getElementById('pCity').value }) });
    currentUser.username = d.username;
    updateNav();
    document.getElementById('profileAlert').innerHTML = '<div class="alert alert-success">Profil mis à jour !</div>';
  } catch (err) { document.getElementById('profileAlert').innerHTML = `<div class="alert alert-error">${err.message}</div>`; }
  return false;
}

// ── Utils ───────────────────────────────────────────────
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function timeAgo(d) {
  const s = Math.floor((Date.now() - new Date(d).getTime()) / 1000);
  if (s < 60) return 'à l\'instant';
  if (s < 3600) return Math.floor(s / 60) + ' min';
  if (s < 86400) return Math.floor(s / 3600) + ' h';
  return Math.floor(s / 86400) + ' j';
}

// ── Init ────────────────────────────────────────────────
(async () => {
  await loadCategories();
  await initAuth();
  searchAnnonces();
})();
</script>
</body>
</html>
